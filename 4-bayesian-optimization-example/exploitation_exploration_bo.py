import numpy as np
import matplotlib.pyplot as plt

from bayes_opt import BayesianOptimization

np.random.seed(42)
xs = np.linspace(-2, 10, 10000)


def f(x):
    """定义目标函数"""
    return np.exp(-(x - 2) ** 2) + np.exp(-(x - 6) ** 2 / 10) + 1 / (x ** 2 + 1)


plt.plot(xs, f(xs))
plt.show()


def plot_bo(f, bo):
    """绘制贝叶斯优化过程"""
    x = np.linspace(-2, 10, 10000)
    mean, sigma = bo._gp.predict(x.reshape(-1, 1), return_std=True)

    plt.figure(figsize=(16, 9))
    plt.plot(x, f(x))
    plt.plot(x, mean)
    plt.fill_between(x, mean + sigma, mean - sigma, alpha=0.1)
    plt.scatter(bo.space.params.flatten(), bo.space.target, c="red", s=50, zorder=10)
    plt.show()


# 构造BO对象
bo = BayesianOptimization(
    f=f,
    pbounds={"x": (-2, 10)},
    verbose=0,
    random_state=987234,
)
# 设置一个kappa值，小的值是偏向于exploitation，即在现有值附近探索，保证更大
bo.maximize(n_iter=10, acq="ucb", kappa=0.1)

plot_bo(f, bo)

bo = BayesianOptimization(
    f=f,
    pbounds={"x": (-2, 10)},
    verbose=0,
    random_state=987234,
)
# 设置新的较大kappa值，尽可能地探索未知的空间
bo.maximize(n_iter=10, acq="ucb", kappa=10)

plot_bo(f, bo)

bo = BayesianOptimization(
    f=f,
    pbounds={"x": (-2, 10)},
    verbose=0,
    random_state=987234,
)

# 换一个提取函数，换为EI方法。xi小的时候，偏向于exploitation
bo.maximize(n_iter=10, acq="ei", xi=1e-4)

plot_bo(f, bo)

bo = BayesianOptimization(
    f=f,
    pbounds={"x": (-2, 10)},
    verbose=0,
    random_state=987234,
)
# 偏大的时候，偏向于探索exploration
bo.maximize(n_iter=10, acq="ei", xi=1e-1)

plot_bo(f, bo)

bo = BayesianOptimization(
    f=f,
    pbounds={"x": (-2, 10)},
    verbose=0,
    random_state=987234,
)
# 常用的另一种方法，poi法。同样，小的xi篇exploition，大的偏exploration
bo.maximize(n_iter=10, acq="poi", xi=1e-4)

plot_bo(f, bo)

bo = BayesianOptimization(
    f=f,
    pbounds={"x": (-2, 10)},
    verbose=0,
    random_state=987234,
)

bo.maximize(n_iter=10, acq="poi", xi=1e-1)

plot_bo(f, bo)
